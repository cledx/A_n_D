<div class="row g-3">
<%# stories grid %>
  <div class="col-md-8">
    <div class="bg-light p-4 card-border fill-page">
      <div class="d-flex justify-content-between align-items-center ms-3">
        <h2 class="mb-0">My Stories</h2>
        <%= link_to "New Journey", "#", class: "btn btn-secondary me-3", data: { bs_toggle: "modal", bs_target: "#newJourneyButton" } %>
      </div>
      <div class="stories-grid overflow-y-auto">
        <% @stories.each do |story| %>
          <% if story.messages.any? %>
            <% last_message = story.messages.last %>
            <%= link_to message_path(last_message), class: "story-card text-decoration-none text-dark" do %>
              <div class="story-image py-2 ps-2">
                <% if story.character.photo.attached? %>
                  <%= cl_image_tag(story.character.photo.key) %>
                  <% else %>
                  <img src="https://raw.githubusercontent.com/lewagon/fullstack-images/master/uikit/skateboard.jpg"/>
                <% end %>
              </div>
              <div class="story-content">
                <h2><%= story.title %></h2>
                <p><%= truncate(last_message.content, length: 80) %></p>
              </div>
            <% end %>
          <% else %>
            <div class="story-card disabled my-2">
              <div class="story-image">
                <% if story.character.photo.attached? %>
                  <%= cl_image_tag(story.character.photo.key) %>
                  <% else %>
                  <img src="https://raw.githubusercontent.com/lewagon/fullstack-images/master/uikit/skateboard.jpg"/>
                <% end %>
              </div>
              <div class="story-content">
                <h3><%= story.title %></h3>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
<%# characters panel %>
  <div class="col-md-4">
    <div class="bg-light p-4 card-border fill-page">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="mb-0">My Characters</h2>
        <%= link_to "+", new_character_path, class: "btn btn-primary" %>
      </div>
      <turbo-frame id="character_card">
        <div class="my-character-card my-3 pt-3 ps-4 pe-4 pb-2">
          <% character = @selected_character %>
          <%= image_tag(
                character&.photo&.attached? ?
                  cl_image_path(character.photo.key) :
                  "placeholder.png",
                class: "img-fluid"
              ) %>
          <div class="my-character-info">
              <h3 class="mt-2 mb-0"><%= character.name || " " %></h3>
              <div class="d-flex justify-content-between">
                <p class="m-0 text-light"><%= character.character_class || " " %></p>
                <p class="m-0 text-light"><%= character.race || " " %></p>
              </div>
          </div>
        </div>
      </turbo-frame>
<%# avatars %>
<ul class="list-unstyled d-flex flex-wrap gap-2 mt-3" data-controller="avatar-select">
  <% @characters.each do |character| %>
    <li>
      <%= link_to stories_path(character_id: character.id), data: {turbo_frame: "character_card", action: "click->avatar-select#select"} do %>
        <%= image_tag "placeholder.png", class: "avatar-large", data: { avatar_select_target: "avatar" } %>
      <% end %>
    </li>
  <% end %>
</ul>
<%# new journey button modal %>
<div class="modal fade" id="newJourneyButton" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content text-white text-center">
      <div class="modal-header position-relative">
        <h1 class="modal-title fs-2 mx-auto">Start a New Journey</h1>
        <button type="button" class="text-white fs-3 bg-transparent border-0 position-absolute end-0 top-0 me-3" data-bs-dismiss="modal">
          x
        </button>
      </div>
      <div class="modal-body">
        <% if current_user.characters.any? %>
          <h5 class="mb-4">Choose a Character</h5>
          <div class="d-flex flex-wrap justify-content-center gap-3">
            <% current_user.characters.each do |character| %>
              <div class="character-hover-wrapper position-relative">
                <%= link_to new_character_story_path(character), class: "text-decoration-none" do %>
                  <%= image_tag(character.photo.attached? ? cl_image_path(character.photo.key, crop: :fill) : "placeholder.png", class: "avatar-large") %>
                <% end %>
                <div class="character-name-popover">
                  <%= character.name %>
                </div>
              </div>
            <% end %>
            <div class="character-hover-wrapper position-relative">
              <%= link_to new_character_path, class: "text-decoration-none" do %>
                <div class="avatar-large create-avatar d-flex align-items-center justify-content-center bg-dark">
                  <i class="fa-solid fa-circle-plus fa-2x fs-1"></i>
                </div>
              <% end %>
              <div class="character-name-popover">
                Create a New Character
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
